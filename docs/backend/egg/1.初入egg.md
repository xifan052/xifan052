#

è¿™é‡Œå¾ˆå¤šå†…å®¹å°±ç…§æ¬å®˜ç½‘å•¦ ğŸ¤ªğŸ¤ªğŸ¤ª

## ä¸€ã€åˆ›å»º egg é¡¹ç›®

åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹

```bash
 mkdir egg-example && cd egg-example
```

ä½¿ç”¨ egg æä¾›çš„æ¨¡æ¿åˆå§‹åŒ–é¡¹ç›®

```bash
 npm init egg --type=simple
```

ä¸‹è½½é¡¹ç›®ä¾èµ–ï¼Œå¯åŠ¨é¡¹ç›®

```bash
 npm install
 npm run dev
```

## äºŒã€ç›®å½•ç»“æ„

è¿™é‡Œå°±åªè¯´ä¸‹å¸¸ç”¨çš„ç›®å½•ï¼Œç‚¹å‡»[é“¾æ¥](https://eggjs.org/zh-cn/basics/structure.html)äº†è§£æ›´å¤š

- `app/router.js`å®šä¹‰æ¥å£ï¼ŒåŒ…æ‹¬æ¥å£åœ°å€ã€æ¥å£ç±»å‹ï¼›

- `app/controller/**`è§£æç”¨æˆ·è¾“å…¥ï¼Œå¤„ç†è¿”å›å¯¹åº”ç»“æœï¼›

- `app/service/**`å¤„ç†å„ç§å¢åˆ æ”¹æŸ¥çš„é€»è¾‘ï¼Œæ•°æ®åº“æ“ä½œã€ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨ï¼›

- `app/public/**`ç”¨äºæ”¾ç½®é™æ€èµ„æºï¼›

- `config/config.{env}.js`ç”¨äºç¼–å†™å„ç§é…ç½®çš„æ–‡ä»¶ï¼›

- `config/plugin.js`ç”¨äºé…ç½®éœ€è¦åŠ è½½çš„æ’ä»¶ï¼›

## ä¸‰ã€egg ä¸­çš„æ¥å£è·¯ç”±

### 1.å®šä¹‰è·¯ç”±

`app/router.js`é‡Œé¢å®šä¹‰ URL è·¯ç”±è§„åˆ™

```js
// app/router.js
module.exports = (app) => {
  const { router, controller } = app
  router.get('/user/:id', controller.user.info)
}
```

`app/controller` ç›®å½•ä¸‹é¢å®ç° Controller

```js
// app/controller/user.js
class UserController extends Controller {
  async info() {
    const { ctx } = this
    ctx.body = {
      name: `hello ${ctx.params.id}`,
    }
  }
}
```

è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªæœ€ç®€å•çš„ Router å®šä¹‰ï¼Œå½“ç”¨æˆ·æ‰§è¡Œ `GET /user/123`ï¼Œ`user.js` è¿™ä¸ªé‡Œé¢çš„ info æ–¹æ³•å°±ä¼šæ‰§è¡Œã€‚

### 2.è·å–å‚æ•°

ç®€å•è¯´ä¸‹è·¯ç”±çš„å‚æ•°è·å–ï¼Œåˆ†ä¸ºä¸‰ç§ï¼š

**2.1.å‚æ•°å‘½åæ–¹å¼:**

åœ¨ router ä¸­é€šè¿‡ `:id`ï¼Œæ¥å—å‚æ•°

```js
router.get('/user/findById/:id', app.controller.user.info)
```

åœ¨ controller ä¸­ï¼Œé€šè¿‡`params`æ‹¿å‚æ•°

```js
async info() {
  const { ctx } = this
  ctx.body = ctx.params.id
}

// curl http://127.0.0.1:7001/user/findById/20579
```

**2.2.Query String æ–¹å¼:**

`router` ä¸­æ— éœ€å£°æ˜å‚æ•°ï¼Œå®šä¹‰æ¥å£è·¯å¾„å°±å¯ä»¥äº†

```js
router.get('/search', app.controller.search.index)
```

é€šè¿‡`query`æ‹¿å‚æ•°

```js
// app/controller/search.js
async index() {
  const { ctx } = this
  ctx.body = ctx.query.name,
}

// curl http://127.0.0.1:7001/search?name=egg
```

**2.3.è¡¨å•å†…å®¹çš„è·å–:**

```js
router.post('/form', app.controller.form.add)

// app/controller/form.js
async add() {
  const { ctx } = this
  ctx.body = ctx.request.body,
}

// æ¨¡æ‹Ÿå‘èµ· post è¯·æ±‚ã€‚
// curl -X POST http://127.0.0.1:7001/form --data '{"name":"controller"}' --header 'Content-Type:application/json'
```

æ›´å¤šè·¯ç”±çŸ¥è¯†è·³è½¬[å®˜ç½‘](https://eggjs.org/zh-cn/basics/router.html)

## å››ã€æ•°æ®åº“æ“ä½œ

è¿™é‡Œä»¥ mysql ä¸ºä¾‹

### 1.é…ç½®æ•°æ®åº“

ç»ˆç«¯è¾“å…¥`npm i egg-mysql`å®‰è£…`egg-mysql`;

åœ¨ plugin ä¸­é…ç½®

```js
// config/plugin.js
module.exports = {
  mysql: {
    enable: true,
    package: 'egg-mysql',
  },
}
```

è®¾ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯

```js
// config/config.default.js

config.mysql = {
  // å•æ•°æ®åº“ä¿¡æ¯é…ç½®
  client: {
    host: 'localhost', // host
    port: '3306', // ç«¯å£å·
    user: 'root', // ç”¨æˆ·å
    password: 'root', // å¯†ç 
    database: 'article', // æ•°æ®åº“å
  },
  app: true, // æ˜¯å¦åŠ è½½åˆ° app ä¸Šï¼Œé»˜è®¤å¼€å¯
  agent: false, // æ˜¯å¦åŠ è½½åˆ° agent ä¸Šï¼Œé»˜è®¤å…³é—­
}
// äº†è§£æ›´å¤šè·³è½¬https://eggjs.org/zh-cn/tutorials/mysql.html#egg-mysql
```

### 2.æ•°æ®å¤„ç†

- å¢åŠ æ•°æ®

```js
const { app } = this
const result = await app.mysql.insert('user', {
  username: 'èµµå››',
  password: '223423',
})
```

- åˆ é™¤æ•°æ®

```js
const { app } = this
const result = await app.mysql.delete('user', { id: 4 })
```

- ä¿®æ”¹æ•°æ®

```js
// ç¬¬ä¸€ç§æ–¹å¼:æ ¹æ®ä¸»é”®ä¿®æ”¹

const row = { id: 7, username: 'èµµå››' }
const result = await this.app.mysql.update('user', row)
// ç¬¬äºŒç§æ–¹å¼:é€šè¿‡ sql æ¥ä¿®æ”¹æ•°æ®
const results = await this.app.mysql.query(
  'update user set username = ? where id = ?',
  [6666, 8]
)
```

- æŸ¥è¯¢æ•°æ®

```js
const { app } = this
// ç¬¬ä¸€ç§æ–¹å¼
const result = await app.mysql.get('user', { id: 2 })
//  ç¬¬äºŒç§æ–¹å¼
const result = await app.mysql.select('user', {
  where: { id: '3' }, // æŸ¥è¯¢æ¡ä»¶
  // orders: [['created_at','desc'], ['id','desc']], // æ’åº
  limit: 10, // æ¯é¡µæ¡æ•°
  offset: 0, // é¡µæ•°
})
```

[å®˜ç½‘ä¼ é€é—¨](https://eggjs.org/zh-cn/tutorials/mysql.html#%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99-crud-%E8%AF%AD%E5%8F%A5)
[åšå®¢å›­ä¼ é€é—¨](https://www.cnblogs.com/loaderman/p/11571028.html)

## äº”ã€egg æ¨¡æ¿æ¸²æŸ“

ç»ˆç«¯è¾“å…¥`npm i egg-view-ejs`å®‰è£…`egg-view-ejs`;

é…ç½® plugin

```js
// config/plugin.js
module.exports = {
  ejs: {
    enable: true,
    package: 'egg-view-ejs',
  },
}
```

è®¾ç½® html æ–‡ä»¶ä»¥ ejs è§£æ

```js
// config/config.default.js

config.view = {
  mapping: {
    '.html': 'ejs',
  },
}
```

æŒ‡å®šè§£æçš„ html æ–‡ä»¶ï¼Œè¿”å›æ¥å£æ•°æ®

```js
// app/controller/home.js
const Controller = require('egg').Controller

class HomeController extends Controller {
  async index() {
    const { ctx } = this
    const res = {
      id: 1559,
      name: 'tom',
      age: 18,
    }
    await ctx.render('index.html', {
      res,
      list: ['a', 'b', 'c'],
    })
  }
}

module.exports = HomeController
```

html è·å–æ•°æ®ï¼Œæ¸²æŸ“é¡µé¢

```js
// app/view/index.html
<p>
  id:<%=res.id%>
</p>
<ul>
  <%for(var i=0; i<list.length;i++){%>
    <li>
      <%=list[i]%>
    </li>
  <%}%>
</ul>
```
